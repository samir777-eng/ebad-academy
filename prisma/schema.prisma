// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  idNumber      String?   @unique
  email         String    @unique
  name          String
  phoneNumber   String?
  password      String
  role          String    @default("student") // "student" or "admin"
  languagePref  String    @default("ar") // "ar" or "en"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  progress      UserProgress[]
  levelStatus   UserLevelStatus[]
  quizAttempts  QuizAttempt[]
  badges        UserBadge[]
  lessonNotes   LessonNote[]
  spiritualProgress SpiritualProgress[]
  actionItemCompletions ActionItemCompletion[]
  videoTimestamps VideoTimestamp[]
  lessonBookmarks LessonBookmark[]
  createdMindMapNodes MindMapNode[] @relation("CreatedMindMapNodes")

  @@index([email])
  @@index([role])
  @@index([createdAt])
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String   // Admin who performed the action
  action        String   // e.g., "USER_DELETED", "ROLE_CHANGED", "LESSON_DELETED"
  entityType    String   // e.g., "User", "Lesson", "Badge"
  entityId      String   // ID of the affected entity
  details       String?  // JSON string with additional details
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

model Level {
  id              Int       @id @default(autoincrement())
  levelNumber     Int       @unique // 1, 2, 3, 4
  nameAr          String
  nameEn          String
  descriptionAr   String
  descriptionEn   String
  order           Int
  
  lessons         Lesson[]
  userStatus      UserLevelStatus[]
}

model Branch {
  id        Int       @id @default(autoincrement())
  nameAr    String    @unique // العقيدة
  nameEn    String    @unique // Aqeedah
  icon      String    // Icon identifier
  slug      String    @unique
  order     Int
  
  lessons   Lesson[]
}

model Lesson {
  id              Int       @id @default(autoincrement())
  branchId        Int
  levelId         Int
  titleAr         String
  titleEn         String
  descriptionAr   String?   // Brief description
  descriptionEn   String?   // Brief description
  videoUrlsAr     String?   // JSON array of video URLs for Arabic
  videoUrlsEn     String?   // JSON array of video URLs for English
  pdfUrlAr        String?
  pdfUrlEn        String?
  mindmapData     String?   // Interactive mind map structure (JSON string) - DEPRECATED, use mindMapNodes
  actionItemsAr   String?   // JSON array of action items in Arabic
  actionItemsEn   String?   // JSON array of action items in English
  duration        Int       // Estimated minutes
  order           Int

  branch          Branch    @relation(fields: [branchId], references: [id])
  level           Level     @relation(fields: [levelId], references: [id])
  questions       Question[]
  userProgress    UserProgress[]
  quizAttempts    QuizAttempt[]
  notes           LessonNote[]
  actionItemCompletions ActionItemCompletion[]
  videoTimestamps VideoTimestamp[]
  bookmarks       LessonBookmark[]
  mindMapNodes    MindMapNode[]

  @@unique([branchId, levelId, order])
  @@index([branchId])
  @@index([levelId])
  @@index([branchId, levelId])
}

model Question {
  id              Int       @id @default(autoincrement())
  lessonId        Int
  questionTextAr  String
  questionTextEn  String
  type            String    // "multiple_choice" or "true_false"
  optionsAr       String?   // ["option1", "option2", ...] for MCQ (JSON string)
  optionsEn       String?   // ["option1", "option2", ...] for MCQ (JSON string)
  correctAnswer   String    // Index or "true"/"false"
  explanationAr   String?
  explanationEn   String?
  order           Int
  
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  userAnswers     UserAnswer[]
}

model UserProgress {
  id              Int       @id @default(autoincrement())
  userId          String
  lessonId        Int
  completed       Boolean   @default(false)
  markedAsRead    Boolean   @default(false) // User marked lesson as read
  score           Float?    // Percentage (0-100)
  attempts        Int       @default(0)
  lastAttempt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([completed])
  @@index([updatedAt])
}

model UserLevelStatus {
  id                    Int       @id @default(autoincrement())
  userId                String
  levelId               Int
  isUnlocked            Boolean   @default(false)
  completionPercentage  Float     @default(0)
  unlockedAt            DateTime?
  
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  level                 Level     @relation(fields: [levelId], references: [id])
  
  @@unique([userId, levelId])
}

model QuizAttempt {
  id              Int       @id @default(autoincrement())
  userId          String
  lessonId        Int
  score           Float
  totalQuestions  Int
  correctAnswers  Int
  passed          Boolean
  attemptDate     DateTime  @default(now())

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  answers         UserAnswer[]

  @@index([userId])
  @@index([lessonId])
  @@index([attemptDate])
  @@index([passed])
}

model UserAnswer {
  id              Int       @id @default(autoincrement())
  attemptId       Int
  questionId      Int
  answer          String
  isCorrect       Boolean

  attempt         QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question        Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Badge {
  id              Int       @id @default(autoincrement())
  nameAr          String
  nameEn          String
  descriptionAr   String
  descriptionEn   String
  iconUrl         String
  criteria        String    // Conditions to earn this badge (JSON string)

  userBadges      UserBadge[]
}

model UserBadge {
  id              Int       @id @default(autoincrement())
  userId          String
  badgeId         Int
  earnedDate      DateTime  @default(now())

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge           Badge     @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
}

model LessonNote {
  id        Int      @id @default(autoincrement())
  userId    String
  lessonId  Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model SpiritualProgress {
  id          Int      @id @default(autoincrement())
  userId      String
  date        DateTime @default(now())

  // Daily worship tracking
  fajr        Boolean  @default(false)
  dhuhr       Boolean  @default(false)
  asr         Boolean  @default(false)
  maghrib     Boolean  @default(false)
  isha        Boolean  @default(false)

  // Quran tracking
  quranPages  Int      @default(0)
  quranMinutes Int     @default(0)

  // Fasting
  fasting     Boolean  @default(false)

  // Good deeds
  charity     Boolean  @default(false)
  charityAmount Float  @default(0)

  dhikr       Boolean  @default(false)
  dhikrCount  Int      @default(0)

  dua         Boolean  @default(false)

  goodDeeds   String?  // JSON array of good deeds
  notes       String?  // Personal reflection

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model ActionItemCompletion {
  id          Int      @id @default(autoincrement())
  userId      String
  lessonId    Int
  itemIndex   Int      // Index of the action item in the lesson's actionItems array
  completed   Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId, itemIndex])
  @@index([userId])
  @@index([lessonId])
}

model VideoTimestamp {
  id          Int      @id @default(autoincrement())
  userId      String
  lessonId    Int
  videoIndex  Int      // Which video in the lesson (0-based index)
  timestamp   Int      // Time in seconds
  label       String   // User-defined label for this timestamp
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
  @@index([userId, lessonId])
}

model LessonBookmark {
  id          Int      @id @default(autoincrement())
  userId      String
  lessonId    Int
  createdAt   DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

// Mind Map Node Model
model MindMapNode {
  id              String   @id @default(cuid())

  // Link to existing lesson
  lessonId        Int
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Hierarchy
  parentId        String?
  parent          MindMapNode?  @relation("NodeHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children        MindMapNode[] @relation("NodeHierarchy")

  // Bilingual content
  titleAr         String
  titleEn         String
  descriptionAr   String?
  descriptionEn   String?

  // Metadata
  type            String   @default("TOPIC") // ROOT, CATEGORY, TOPIC, SUBTOPIC, DETAIL, NOTE
  level           Int      @default(0)  // Depth in tree
  order           Int      @default(0)  // Display order among siblings

  // Visual properties
  color           String   @default("#4F46E5")
  icon            String?
  shape           String   @default("circle") // circle, rect, diamond

  // Canvas positioning (for admin visual editor)
  positionX       Float?
  positionY       Float?
  collapsed       Boolean  @default(false)

  // Historical Context (inspired by Seerah project)
  dateHijri       String?  // Hijri date (e.g., "12 Rabi' al-Awwal 1 AH")
  dateGregorian   String?  // Gregorian date (e.g., "622 CE")
  location        String?  // Location of event
  participants    String?  // JSON array of participants

  // Decision Analysis
  decision        String?  // Main decision made
  alternatives    String?  // JSON array of alternative options considered
  outcomes        String?  // JSON array of outcomes/results

  // Learning & Application
  moralLessons    String?  // JSON array of moral/spiritual lessons
  modernApps      String?  // JSON array of modern applications
  securityImpact  String?  // Security/strategic impact analysis

  // Documentation
  sources         String?  // JSON array of source references

  // Flexible metadata for future extensions
  metadata        String?  // JSON for additional custom fields

  // Status
  isPublished     Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  creator         User     @relation("CreatedMindMapNodes", fields: [createdBy], references: [id])

  // Relations
  relationships   MindMapRelationship[] @relation("FromNode")
  relatedTo       MindMapRelationship[] @relation("ToNode")
  attachments     MindMapAttachment[]

  @@index([lessonId])
  @@index([parentId])
  @@index([isPublished])
  @@index([type])
  @@index([createdBy])
  // Composite indexes for common query patterns
  @@index([lessonId, isPublished])
  @@index([lessonId, level, order])
  @@index([lessonId, type])
  @@index([parentId, order])
}

// Mind Map Relationship (connections between nodes)
model MindMapRelationship {
  id              String   @id @default(cuid())

  fromNodeId      String
  fromNode        MindMapNode @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)

  toNodeId        String
  toNode          MindMapNode @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  sourceHandle    String?  // Handle ID on the source node (e.g., "right", "bottom")
  targetHandle    String?  // Handle ID on the target node (e.g., "left", "top")

  type            String   @default("RELATED") // RELATED, PREREQUISITE, LEADS_TO, EXAMPLE_OF, CONTRADICTS, ELABORATES, PART_OF
  labelAr         String?
  labelEn         String?

  // Visual properties
  lineStyle       String   @default("solid") // solid, dashed, dotted
  lineWidth       Int      @default(2)
  color           String   @default("#94a3b8")

  createdAt       DateTime @default(now())

  @@unique([fromNodeId, toNodeId, type])
  @@index([fromNodeId])
  @@index([toNodeId])
}

// Attachments to nodes (Ayahs, Hadiths, notes, links)
model MindMapAttachment {
  id              String   @id @default(cuid())
  nodeId          String
  node            MindMapNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  type            String   // AYAH, HADITH, NOTE, LINK, IMAGE
  titleAr         String
  titleEn         String
  contentAr       String?
  contentEn       String?
  url             String?

  order           Int      @default(0)
  createdAt       DateTime @default(now())

  @@index([nodeId])
}
